@page "/view_recipes/{id:int}"
@model ProjetoAssembly_Final.Pages.view_recipesModel
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<ProjetoAssembly_Final.Pages.IndexModel> Localizer
@{
    Layout = "_layout";
    ViewData["Title"] = Model.Recipe?.Title;
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/recipe.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/pages/comments.css" asp-append-version="true" />
}


<main class="container">
    <section class="detalhe_receita" style="padding-top: 40px;">
        
        @if (Model.IsReviewMode)
        {
            <div class="alert alert-warning d-flex justify-content-between align-items-center shadow-sm mb-4" style="border-left: 5px solid #ffc107">
                <div>
                    <i class="fa-solid fa-circle-exclamation fa-lg me-2"></i>
                    <strong>Modo de Revisão</strong> Esta receita aguarda aprovação para se tornar pública.
                </div>
                <div class="d-flex gap-2">
                    <form method="post" asp-page="/PendingRecipes" asp-page-handler="Approve">
                        <input type="hidden" name="id" value="@Model.Recipe.RecipesId" />
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="fa-solid fa-check"></i> Aprovar agora
                        </button>
                    </form>
                    <a asp-page="/PendingRecipes" class="btn btn-outline-secondary btn-sm">Voltar à lista</a>
                </div>
            </div>
        }

        <h1 class="section-title">@Model.Recipe?.Title</h1>

        @if(!Model.IsReviewMode && User.Identity?.IsAuthenticated == true && Model.Recipe?.UserId == 1)
        {
            <div style="text-align: right; margin-bottom: 20px;">
                <a asp-page="/editRecipe" asp-route-id="@Model.Recipe?.RecipesId" class="btn-gestao editar" style="display: inline-flex; width: auto; padding: 10px 20px;">
                    <i class="fa-solid fa-pen-to-square"></i> @Localizer["Editar a minha receita"]
                </a>
            </div>
        }       

         <div class="row" style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div class="col" style="flex: 1; min-width: 300px;">
                <img src="/img/@(string.IsNullOrEmpty(Model.Recipe?.ImageUrl) ? "default.jpg" : Model.Recipe.ImageUrl)"
                     alt="@Model.Recipe?.Title"
                     style="width: 100%; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">

                <div class="recipe-meta-box" style="margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                    <p><strong><i class="fa-solid fa-users"></i> Dose:</strong> @Model.Recipe?.Servings</p>
                    <p><strong><i class="fa-regular fa-clock"></i> Tempo total:</strong> @(Model.Recipe?.PrepTimeMinutes + Model.Recipe?.CookTimeMinutes) min</p>
                    <p>
                        <strong><i class="fa-solid fa-gauge-high"></i> Dificuldade:</strong>
                        <span class="badge-dif @(Model.Recipe?.DifficultyId == 1 ? "dif-facil" : "dif-media")">
                            @(Model.Recipe?.DifficultyId == 1 ? "Fácil" : "Média")
                        </span>
                    </p>
                </div>
            </div>       

            <div class="col" style="flex: 2; min-width: 300px;">
                <h3><i class="fa-solid fa-list-ul"></i> Ingredientes</h3>
                <ul class="lista-ingredientes" style="list-style: none; padding: 0; margin-bottom: 30px;">
                    @if (Model.Recipe?.Ingredients != null)
                    {
                        @foreach (var ing in Model.Recipe.Ingredients)
                        {
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <i class="fa-solid fa-check" style="color: #28a745; margin-right: 10px;"></i>
                                @ing.QuantityValue @ing.Unit de @(ing.Ingredient?.IngredientName ?? "Ingrediente")
                            </li>
                        }
                    }
                </ul>

                <h3><i class="fa-solid fa-mitten"></i> @Localizer["Modo de Preparação"]</h3>
                <div style="line-height: 1.6; color: #444; white-space: pre-line;">
                    @Model.Recipe?.Instructions
                </div>
            </div>
        </div>
    </section>

    <hr class="dropdown-divider" style="margin: 40px 0;">          

    <section class="seccao-comentarios">
        <h2 class="section-title"><i class="fa-solid fa-comments"></i> @Localizer["Comentários e Avaliações"]</h2>
        
        @if (!(User.Identity?.IsAuthenticated ?? false))
        {
            <div class="login-prompt-box" style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px;">
                <i class="fa-solid fa-lock" style="font-size: 2rem; color: #ccc; margin-bottom: 15px"></i>
                <h4>Quer deixar a sua opinião?</h4>
                <p>@Localizer["Apenas utilizadores registados podem comentar."]</p>
                <div style="margin-top: 15px">
                    <a asp-page="/Login" class="btn btn-success">@Localizer["Entrar"]</a>
                    <a asp-page="/Regist" class="btn btn-outline-secondary" style="margin-left: 10px;">@Localizer["Criar conta"]</a>
                </div>
            </div>
        }
         
        <partial name="_CommentsSection" model='new ProjetoAssembly_Final.Pages.Shared._CommentsSectionModel { 
            ListComments = Model.ListComments, 
            RecipeId = Model.Recipe?.RecipesId ?? 0 
        }' />
        
    </section>
</main>
