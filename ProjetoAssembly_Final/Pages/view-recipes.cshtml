@page "{id:int}"
@model ProjetoAssembly_Final.Pages.view_recipesModel
@{
    Layout = "_layout";
    ViewData["Title"] = Model.Recipe?.Title;
}

<link rel="stylesheet" href="~/css/recipe.css" />

<main class="container">
    <section class="detalhe_receita" style="padding-top: 40px;">
        <h1 class="section-title">@Model.Recipe?.Title</h1>

        <div class="row" style="display: flex; gap: 30px; flex-wrap: wrap;">
            <div class="col" style="flex: 1; min-width: 300px;">
                <img src="/img/@(string.IsNullOrEmpty(Model.Recipe?.ImageUrl) ? "default.jpg" : Model.Recipe.ImageUrl)"
                     alt="@Model.Recipe?.Title"
                     style="width: 100%; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">

                <div class="recipe-meta-box" style="margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                    <p><strong><i class="fa-solid fa-users"></i> Dose:</strong> @Model.Recipe?.Servings</p>
                    <p><strong><i class="fa-regular fa-clock"></i> Tempo total:</strong> @(Model.Recipe?.PrepTimeMinutes + Model.Recipe?.CookTimeMinutes) min</p>
                    <p>
                        <strong><i class="fa-solid fa-gauge-high"></i> Dificuldade:</strong>
                        <span class="badge-dif @(Model.Recipe?.DifficultyId == 1 ? "dif-facil" : "dif-media")">
                            @(Model.Recipe?.DifficultyId == 1 ? "Fácil" : "Média")
                        </span>
                    </p>
                </div>
            </div>

            <div class="col" style="flex: 2; min-width: 300px;">
                <h3><i class="fa-solid fa-list-ul"></i> Ingredientes</h3>
                <ul class="lista-ingredientes" style="list-style: none; padding: 0; margin-bottom: 30px;">
                    @if (Model.Recipe?.Ingredients != null)
                    {
                        @foreach (var ing in Model.Recipe.Ingredients)
                        {
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <i class="fa-solid fa-check" style="color: #28a745; margin-right: 10px;"></i>
                                @ing.QuantityValue @ing.Unit de @(ing.Ingredient?.IngredientName ?? "Ingrediente")
                            </li>
                        }
                    }
                </ul>

                <h3><i class="fa-solid fa-mitten"></i> Modo de Preparação</h3>
                <div style="line-height: 1.6; color: #444; white-space: pre-line;">
                    @Model.Recipe?.Instructions
                </div>
            </div>
        </div>
    </section>

    <hr class="dropdown-divider" style="margin: 40px 0;">          

    <section class="seccao-comentarios">
        <h2 class="section-title"><i class="fa-solid fa-comments"></i> Comentários e Avaliações</h2>
        
        @if (User.Identity?.IsAuthenticated ?? false)
        {
            <div class="comentarios-form-container">
                <form method="post">
                    <input type="hidden" name="receitaId" value="@Model.Recipe?.RecipesId">            

                    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px;">
                        <strong>A sua avaliação:</strong>
                        <select name="rating" class="form-select-stars">
                            <option value="5">⭐⭐⭐⭐⭐ (Incrível)</option>
                            <option value="4">⭐⭐⭐⭐ (Muito bom)</option>
                            <option value="3">⭐⭐⭐ (Bom)</option>
                            <option value="2">⭐⭐ (Razoável)</option>
                            <option value="1">⭐(Fraco)</option>
                        </select>
                    </div>

                    <textarea name="mensagem" class="form-control-modern" rows="4" required 
                            placeholder="Partilhe a sua experiÊncia com esta receita..."></textarea>

                    <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                        <button type="submit" class="btn-publicar">
                            <i class="fa-solid fa-paper-plane"></i> Publicar Comentário</button>
                    </div>
                </form>
            </div>
        }
        else
        {
            <div class="login-prompt-box">
                <i class="fa-solid fa-lock" style="font-size: 2rem; color: #ccc; margin-bottom: 15px"></i>
                <h4>Quer deixar a sua opinião?</h4>
                <p>Apenas utilizadores registados podem comentar e avaliar as receitas.</p>
                <div style="margin-top: 15px">
                    <a asp-page="/Login" class="btn-principal" style="padding: 10px 25px;">Entrar</a>
                    <a asp-page="/Register" class="btn-voltar" style="margin-left: 10px;">Criar conta</a>
                </div>
            </div>
        }      

        <div id="container-comentarios" class="comentarios-lista">
            @if(Model.ListComments != null && Model.ListComments.Any())
            {
                @foreach (var c in Model.ListComments)
                {
                    <div class="comentario-card">
                        <div class="comment-user-info">
                            <div class="user-avatar-circle"><i class="fa-solid fa-user"></i>
                            </div>
                            <strong>Utilizador #@c.UserId</strong>
                            <div class="stars-display">
                                @for(int i=0; i<c.Rating; i++)
                                {
                                    <i class="fa-solid fa-star checked"></i>
                                }
                            </div>
                        </div>
                        <small class="comment-date">@c.CreatedAt.ToString("dd/MM/yyyy")</small>
                    </div>
                    <p class="comment-text">@c.CommentText</p>
                }
            }
            else
            {
                <p class="text-muted text-center" style="margin-top: 20px;">Ainda não existem comentários para esta receita.</p>
            }
        </div>
    </section>
</main>
